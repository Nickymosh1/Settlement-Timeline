<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settlement Runs Timeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="module">
        import { initializeApp } from "https.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, Timestamp, getDocs, writeBatch, setLogLevel as setFirestoreLogLevel } from "https.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase/App Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyBMVUAeKxRu83Pi6eng5my26bgLmVYe09U",
          authDomain: "settlement-timeline.firebaseapp.com",
          projectId: "settlement-timeline",
          storageBucket: "settlement-timeline.firebasestorage.app",
          messagingSenderId: "508924605453",
          appId: "1:508924605453:web:8c765d749c8e5d4c905144"
        };
        
        const appId = firebaseConfig.appId;
        const initialAuthToken = null; 

        // --- Global Firebase Vars ---
        let app, auth, db, userId, isAuthReady = false;
        let settlementCollectionRef;
 
        // --- Global App State ---
        let data = []; 
        
        // D3 Selections
        let container, tooltip;

        // --- Global Setup: Updated Run Types ---
        const runTypes = ["(II) Run", "SSF Run", "(R1) Run", "(R2) Run", "(R3) Run", "(RF) Run", "(DF) Run"];
        const allPeriodTypes = ["Effective", "(II) Run", "SSF Run", "(R1) Run", "(R2) Run", "(R3) Run", "(RF) Run", "(DF) Run"];

        // D3 Formatters
        const parseDate = d3.timeParse("%d/%m/%Y");
        const formatFullDate = d3.timeFormat("%a, %d %B %Y");
        const formatShortDate = d3.timeFormat("%d/%m/%Y"); // UK Date Format
        const formatHtmlDate = d3.timeFormat("%Y-%m-%d");

        /**
         * Helper to parse YYYY-MM-DD string to a JS Date object safely.
         */
        function parseHtmlDate(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('-');
            if (parts.length === 3) {
                // Month is 0-indexed in JS Dates (0 = Jan, 11 = Dec)
                return new Date(parts[0], parts[1] - 1, parts[2]);
            }
            return null;
        }

        /**
         * Adds a number of days to a given date.
         */
        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }
        
        /**
         * Adds a number of months to a given date.
         */
        function addMonths(date, months) {
            const result = new Date(date);
            result.setMonth(result.getMonth() + months);
            return result;
        }

        /**
         * Sets up the real-time listener to Firestore.
         */
        function setupFirestoreListener() {
            if (!isAuthReady || !appId) {
                console.error("Auth or AppId is not ready. Cannot set up listener.");
                return;
            }

            // This is our new shared path
            const collectionPath = `/artifacts/${appId}/shared_settlement_batches`;
            settlementCollectionRef = collection(db, collectionPath);

            onSnapshot(settlementCollectionRef, (snapshot) => {
                // NOTE: The 'if (snapshot.empty)' block that called the
                // seed function has been removed.
                
                // Process snapshot
                data = snapshot.docs.map(doc => {
                    const docData = doc.data();
                    const processedData = {
                        id: doc.id,
                        "No of supplies": docData["No of supplies"],
                        "Effective from date": docData["Effective from date"]?.toDate()
                    };
                    // Dynamically read all run types from the document
                    runTypes.forEach(run => {
                        if (docData[run]) {
                            processedData[run] = docData[run].toDate();
                        }
                    });
                    return processedData;
                });

                data = data.filter(d => d["Effective from date"]);

                // These functions will now correctly render the empty state
                // if the database has no data.
                processAndDraw();
                renderManageDataUI();

            }, (error) => {
                console.error("Error with Firestore snapshot: ", error);
            });
        }


        /**
         * Processes the global 'data' array into segments and redraws the chart.
         */
        function processAndDraw() {
            const processedData = data.map(d => {
                const parsed = { ...d }; 
                const dates = [];
                if (parsed["Effective from date"]) {
                    dates.push({ type: "Effective", date: parsed["Effective from date"] });
                }
                
                runTypes.forEach(run => {
                    const runDate = parsed[run]; 
                    if (runDate) {
                        dates.push({ type: run, date: runDate });
                    }
                });

                dates.sort((a, b) => a.date - b.date);

                parsed.segments = [];
                for (let i = 0; i < dates.length - 1; i++) {
                    if (dates[i].date && dates[i+1].date && dates[i].date < dates[i+1].date) {
                        parsed.segments.push({
                            runType: dates[i].type,
                            startDate: dates[i].date,
                            endDate: dates[i + 1].date,
                            parentData: parsed 
                        });
                    }
                }
                
                parsed.maxDate = dates.length > 0 ? dates[dates.length - 1].date : parsed["Effective from date"];
                return parsed;
            });
            
            if (!container) return; 
            const { width, height } = container.node().getBoundingClientRect();
            if (width > 0 && height > 0) {
                drawChart(width, height, processedData);
            }
        }
        
        /**
         * Renders the list of batches in the "Manage Data" tab.
         */
        function renderManageDataUI() {
            const listContainer = document.getElementById('batch-list-container');
            if (!listContainer) return;

            listContainer.innerHTML = ''; 
            
            if (data.length === 0) {
                listContainer.innerHTML = `<p class="text-slate-500 text-sm">No settlement batches found. Add one using the form above.</p>`;
                return;
            }

            const sortedData = [...data].sort((a, b) => b["Effective from date"] - a["Effective from date"]);

            sortedData.forEach(batch => {
                const batchEl = document.createElement('div');
                batchEl.className = 'bg-slate-50 p-3 rounded-md shadow-sm border border-slate-200 flex justify-between items-center';
                
                const infoEl = document.createElement('div');
                infoEl.className = 'text-sm';
                infoEl.innerHTML = `
                    <strong class="text-slate-700">Effective: ${formatShortDate(batch["Effective from date"])}</strong>
                    <span class="text-slate-500 ml-2">(Supplies: ${batch["No of supplies"]})</span>
                `;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-xs bg-red-100 text-red-700 hover:bg-red-200 px-3 py-1 rounded-md font-medium';
                deleteBtn.textContent = 'Delete';
                deleteBtn.dataset.id = batch.id;
                
                deleteBtn.addEventListener('click', async () => {
                    if (confirm(`Are you sure you want to delete the batch for ${formatShortDate(batch["Effective from date"])}?`)) {
                        const id = deleteBtn.dataset.id;
                        if (id) {
                            try {
                                await deleteDoc(doc(db, settlementCollectionRef.path, id));
                            } catch (error) {
                                console.error("Error deleting document: ", error);
                            }
                        }
                    }
                });
                
                batchEl.appendChild(infoEl);
                batchEl.appendChild(deleteBtn);
                listContainer.appendChild(batchEl);
            });
        }

        /**
         * Handles the submission of the "Add Batch" form.
         */
        async function handleAddBatch(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            try {
                const effectiveDate = parseHtmlDate(formData.get("effectiveDate"));
                if (!effectiveDate) {
                    alert("Effective from date is required.");
                    return;
                }

                // Auto-calculate Settlement Dates based on your rules
                const newBatch = {
                    "Effective from date": Timestamp.fromDate(effectiveDate),
                    "No of supplies": +formData.get("supplies"),
                    "(II) Run": Timestamp.fromDate(addDays(effectiveDate, 7)),     // 1 week
                    "SSF Run":  Timestamp.fromDate(addMonths(effectiveDate, 1)),  // 1 month
                    "(R1) Run": Timestamp.fromDate(addMonths(effectiveDate, 2)),  // 2 months
                    "(R2) Run": Timestamp.fromDate(addMonths(effectiveDate, 5)),  // 5 months
                    "(R3) Run": Timestamp.fromDate(addMonths(effectiveDate, 7)),  // 7 months
                    "(RF) Run": Timestamp.fromDate(addMonths(effectiveDate, 14)), // 14 months
                    "(DF) Run": Timestamp.fromDate(addMonths(effectiveDate, 28))  // 28 months
                };

                // Add to Firestore
                await addDoc(settlementCollectionRef, newBatch);
                
                form.reset();

            } catch (error) {
                console.error("Error adding batch: ", error);
            }
        }


        /**
         * The D3 drawing function.
         */
        function drawChart(containerWidth, containerHeight, chartData) {
            container.selectAll("svg").remove();
            container.selectAll("p").remove(); 

            if (chartData.length === 0) {
                 container.append("p").attr("class", "text-slate-500 p-4").text("No valid data to display. Add data in the 'Manage Data' tab.");
                 return;
            }

            const margin = { top: 40, right: 50, bottom: 60, left: 90 };
            const width = containerWidth - margin.left - margin.right;
            const height = containerHeight - margin.top - margin.bottom;

            const svg = container.append("svg")
                .attr("width", containerWidth)
                .attr("height", containerHeight)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

            // --- 3. Scales ---
            const today = new Date(); 

            const minDate = d3.min(chartData, d => d["Effective from date"]);
            const maxDate = d3.max(chartData, d => d.maxDate);
            
            if (!minDate || !maxDate) {
                 container.append("p").attr("class", "text-slate-500 p-4").text("Could not determine date range from data.");
                 return;
            }
            
            const dateDomain = [d3.timeMonth.floor(minDate), d3.timeMonth.ceil(maxDate)];

            const xScale = d3.scaleTime()
                .domain(dateDomain)
                .range([0, width]);

            const yScale = d3.scaleBand()
                .domain(chartData.map(d => d["Effective from date"]).sort((a,b) => a - b)) // Sort dates
                .range([0, height])
                .padding(0.4);

            const colorScale = d3.scaleOrdinal(d3.schemeCategory10)
                .domain(allPeriodTypes);

            // --- 4. Axes ---
            const xAxis = d3.axisBottom(xScale).ticks(d3.timeMonth.every(1)).tickFormat(d3.timeFormat("%b %Y"));
            const yAxis = d3.axisLeft(yScale).tickFormat(formatShortDate); // Uses new UK format

            const xAxisGroup = svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0, ${height})`)
                .call(xAxis);
            
            xAxisGroup.selectAll("text")
                .attr("transform", "rotate(-30)")
                .attr("text-anchor", "end")
                .attr("dx", "-.5em")
                .attr("dy", ".5em");

            svg.append("g")
                .attr("class", "y-axis")
                .call(yAxis)
                .selectAll("text")
                .attr("font-weight", "600");

            // --- 5. Chart Content ---
            svg.append("defs").append("clipPath")
                .attr("id", "clip")
                .append("rect")
                .attr("width", width)
                .attr("height", height);

            const chartArea = svg.append("g")
                .attr("clip-path", "url(#clip)");

            const zoom = d3.zoom()
                .scaleExtent([0.5, 10]) 
                .translateExtent([[0, 0], [width, height]]) 
                .extent([[0, 0], [width, height]])
                .on("zoom", (event) => {
                    const newXScale = event.transform.rescaleX(xScale);
                    
                    xAxisGroup.call(xAxis.scale(newXScale));
                    xAxisGroup.selectAll("text")
                        .attr("transform", "rotate(-30)")
                        .attr("text-anchor", "end")
                        .attr("dx", "-.5em")
                        .attr("dy", ".5em");

                    chartArea.selectAll(".run-bar")
                        .attr("x", d => newXScale(d.startDate))
                        .attr("width", d => Math.max(0, newXScale(d.endDate) - newXScale(d.startDate)));
                    
                    updateTodayMarker(newXScale);
                });

            chartArea.append("rect")
                .attr("class", "zoom-area")
                .attr("width", width)
                .attr("height", height)
                .style("fill", "none")
                .style("pointer-events", "all")
                .call(zoom);

            const batchGroups = chartArea.selectAll(".batch")
                .data(chartData, d => d.id) 
                .enter()
                .append("g")
                .attr("class", "batch")
                .attr("transform", d => `translate(0, ${yScale(d["Effective from date"])})`);

            batchGroups.selectAll(".run-bar")
                .data(d => d.segments)
                .enter()
                .append("rect")
                .attr("class", "run-bar")
                .attr("x", d => xScale(d.startDate))
                .attr("y", 0)
                .attr("width", d => Math.max(0, xScale(d.endDate) - xScale(d.startDate)))
                .attr("height", yScale.bandwidth())
                .attr("fill", d => colorScale(d.runType))
                .attr("opacity", d => (today >= d.startDate && today < d.endDate) ? 1.0 : 0.6)
                .on("mouseover", (event, d) => {
                    tooltip.style("display", "block")
                        .html(`
                            <strong style="color: ${colorScale(d.runType)}">${d.runType} Period</strong><br>
                            Start: ${formatFullDate(d.startDate)}<br>
                            End: ${formatFullDate(d.endDate)}<br>
                            Duration: ${d3.timeDay.count(d.startDate, d.endDate)} days<br>
                            <hr>
                            <strong>Batch Info (Effective: ${formatShortDate(d.parentData["Effective from date"])})</strong><br>
                            Total Supplies: ${d.parentData["No of supplies"]}<br>
                            
                            <span style="opacity: 0.8; font-size: 0.9em;">
                                (II) Run: ${d.parentData["(II) Run"] ? formatShortDate(d.parentData["(II) Run"]) : 'N/A'}<br>
                                SSF Run: ${d.parentData["SSF Run"] ? formatShortDate(d.parentData["SSF Run"]) : 'N/A'}<br>
                                (R1) Run: ${d.parentData["(R1) Run"] ? formatShortDate(d.parentData["(R1) Run"]) : 'N/A'}<br>
                                (R2) Run: ${d.parentData["(R2) Run"] ? formatShortDate(d.parentData["(R2) Run"]) : 'N/A'}<br>
                                (R3) Run: ${d.parentData["(R3) Run"] ? formatShortDate(d.parentData["(R3) Run"]) : 'N/A'}<br>
                                (RF) Run: ${d.parentData["(RF) Run"] ? formatShortDate(d.parentData["(RF) Run"]) : 'N/A'}<br>
                                (DF) Run: ${d.parentData["(DF) Run"] ? formatShortDate(d.parentData["(DF) Run"]) : 'N/A'}
                            </span>
                        `);
                })
                .on("mousemove", (event) => {
                    let left = event.clientX + 15;
                    let top = event.clientY - 15;
                    
                    const tooltipNode = tooltip.node();
                    if (tooltipNode) {
                        const tooltipWidth = tooltipNode.offsetWidth;
                        const tooltipHeight = tooltipNode.offsetHeight;
                        if (left + tooltipWidth > window.innerWidth) left = event.clientX - tooltipWidth - 15;
                        if (top < 0) top = event.clientY + 15;
                        if (top + tooltipHeight > window.innerHeight) top = event.clientY - tooltipHeight - 15;
                    }
                    tooltip.style("left", left + "px").style("top", top + "px");
                })
                .on("mouseout", () => {
                    tooltip.style("display", "none");
                });

            // --- 5b. Today Marker ---
            const todayMarker = chartArea.append("g")
                .attr("class", "today-marker")
                .style("pointer-events", "none");

            todayMarker.append("line")
                .attr("class", "today-line")
                .attr("y1", 0)
                .attr("y2", height)
                .attr("stroke", "#ef4444") // red-500
                .attr("stroke-width", 2)
                .attr("stroke-dasharray", "4 2");

            todayMarker.append("text")
                .attr("class", "today-text")
                .attr("x", 4)
                .attr("y", 15)
                .attr("fill", "#ef4444")
                .attr("font-size", "0.75rem")
                .attr("font-weight", "600")
                .text("Today");

            function updateTodayMarker(currentXScale) {
                const todayX = currentXScale(today);
                const inRange = todayX >= 0 && todayX <= width;
                todayMarker.style("display", inRange ? "block" : "none");
                if (inRange) {
                    todayMarker.attr("transform", `translate(${todayX}, 0)`);
                }
            }
            updateTodayMarker(xScale);

            // --- 6. Legend ---
            const legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(0, -${margin.top / 2})`);

            const legendItems = legend.selectAll(".legend-item")
                .data(allPeriodTypes)
                .enter()
                .append("g")
                .attr("class", "legend-item")
                .attr("transform", (d, i) => `translate(${i * 80}, 0)`); // Spaced them a bit closer

            legendItems.append("rect")
                .attr("x", 0)
                .attr("y", -5)
                .attr("width", 10)
                .attr("height", 10)
                .attr("fill", d => colorScale(d));

            legendItems.append("text")
                .attr("x", 15)
                .attr("y", 4)
                .text(d => d)
                .attr("font-size", "0.75rem")
                .attr("fill", "#475569");
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            container = d3.select("#chart-container");
            tooltip = d3.select("#tooltip");

            // --- Tab Switching Logic ---
            const tabChartBtn = document.getElementById('tab-chart');
            const tabDataBtn = document.getElementById('tab-data');
            const panelChartEl = document.getElementById('panel-chart');
            const panelDataEl = document.getElementById('panel-data');
            
            const activeTabClasses = 'border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm mr-8';
            const inactiveTabClasses = 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm mr-8';

            tabChartBtn.addEventListener('click', () => {
                tabChartBtn.className = activeTabClasses;
                tabDataBtn.className = inactiveTabClasses;
                panelChartEl.className = 'flex h-[75vh]';
                panelDataEl.className = 'hidden h-[75vh] flex flex-col';
                
                const { width, height } = container.node().getBoundingClientRect();
                if (width > 0 && height > 0 && data.length > 0) {
                    processAndDraw();
                }
            });

            tabDataBtn.addEventListener('click', () => {
                tabDataBtn.className = activeTabClasses;
                tabChartBtn.className = inactiveTabClasses;
                panelDataEl.className = 'block h-[75vh] flex flex-col';
                panelChartEl.className = 'hidden h-[75vh]';
            });
            
            // --- Add Batch Form Logic ---
            const addBatchForm = document.getElementById('add-batch-form');
            addBatchForm.addEventListener('submit', handleAddBatch);
            
            // --- Firebase Initialization ---
            try {
                if (!firebaseConfig.appId) {
                     throw new Error("Firebase 'appId' is missing or empty in your config.");
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setFirestoreLogLevel('debug'); 

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Auth state ready, user ID:", userId);
                        setupFirestoreListener(); 
                    } else {
                        isAuthReady = false;
                        userId = null;
                        console.log("User is signed out.");
                    }
                });

                await signInAnonymously(auth);
                console.log("Signed in anonymously.");

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                container.append("p").attr("class", "text-red-500 p-4").text("Error: Could not connect to data storage. " + error.message);
            }
            
            // --- Resize Observer ---
            const resizeObserver = new ResizeObserver(entries => {
                if (!panelChartEl.classList.contains('hidden')) {
                    const entry = entries[0];
                    const { width, height } = entry.contentRect;
                    if (width > 0 && height > 0) {
                        processAndDraw();
                    }
                }
            });
            resizeObserver.observe(container.node());
        });
    </script>
    <style>
        /* Custom styles for D3 elements */
        body {
            font-family: 'Inter', sans-serif;
        }
        .x-axis path,
        .x-axis line,
        .y-axis path,
        .y-axis line {
            stroke: #e2e8f0; /* Tailwind gray-200 */
        }
        .x-axis text,
        .y-axis text {
            fill: #475569; /* Tailwind slate-600 */
            font-size: 0.75rem;
        }
        .run-bar:hover {
            opacity: 0.8;
            cursor: pointer;
        }
        #tooltip hr {
            border-top: 1px solid #475569; 
            margin-top: 4px;
            margin-bottom: 4px;
        }
        #chart-container {
            min-height: 400px;
        }
        
        #add-batch-form .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        #add-batch-form label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: #475569; /* slate-600 */
            margin-bottom: 0.25rem;
        }
        #add-batch-form input {
            width: 100%;
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #cbd5e1; /* slate-300 */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); /* shadow-sm */
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }
    </style>
</head>
<body class="bg-slate-50 h-full p-4 md:p-8">

    <div class="bg-white rounded-lg shadow-xl p-4 md:p-6 w-full max-w-7xl mx-auto flex flex-col min-h-[90vh]">
        <h1 class="text-2xl font-bold text-slate-800 mb-1">Settlement Runs Timeline</h1>
        <p class="text-sm text-slate-500 mb-4">
            Each row shows a batch of supplies. Colored bars represent the time period between settlement runs.<br>
            Active periods are highlighted (opacity 100%). The red line indicates "Today". You can zoom and pan.
        </t>

        <div class="mt-4">
            <div class="border-b border-slate-200">
                <nav class="flex -mb-px" aria-label="Tabs">
                    <button id="tab-chart" class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm mr-8">
                        Timeline Chart
                    </button>
                    <button id="tab-data" class="border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm mr-8">
                        Manage Data
                    </button>
                </nav>
            </div>

            <div class="mt-6">
                <div id="panel-chart" class="flex h-[75vh]">
                    <div id="chart-container" class="flex-grow w-full h-full relative border rounded-md border-slate-200"></div>
                </div>

                <div id="panel-data" class="hidden h-[75vh] flex flex-col">
                    
                    <h2 class="text-lg font-semibold text-slate-700 mb-2">Add New Batch</h2>
                    <form id="add-batch-form" class="mb-6 p-4 border border-slate-200 rounded-lg bg-slate-50">
                        <div class="form-grid">
                            <div>
                                <label for="effectiveDate">Effective from date</label>
                                <input type="date" id="effectiveDate" name="effectiveDate" required>
                            </div>
                            <div>
                                <label for="supplies">No of supplies</label>
                                <input type="number" id="supplies" name="supplies" required min="0">
                            </div>
                        </div>
                        <button type="submit" class="mt-4 w-full md:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                            Add New Batch
                        </button>
                    </form>

                    <h2 class="text-lg font-semibold text-slate-700 mb-2">Existing Batches</h2>
                    <div id="batch-list-container" class="flex-grow space-y-2 overflow-y-auto p-1">
                        <p class="text-slate-500 text-sm">Loading data...</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="tooltip" class="fixed hidden bg-slate-900 text-white text-xs rounded-md px-3 py-2 shadow-lg" style="pointer-events: none;"></div>

</body>
</html>
