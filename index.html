<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settlement Runs Timeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, Timestamp, getDocs, writeBatch, setLogLevel as setFirestoreLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase/App Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyBMVUAeKxRu83Pi6eng5my26bgLmVYe09U",
          authDomain: "settlement-timeline.firebaseapp.com",
          projectId: "settlement-timeline",
          storageBucket: "settlement-timeline.firebasestorage.app",
          messagingSenderId: "508924605453",
          appId: "1:508924605453:web:8c765d749c8e5d4c905144"
        };

        const appId = firebaseConfig.appId;
        const initialAuthToken = null;

        // --- Global Firebase Vars ---
        let app, auth, db, userId, isAuthReady = false;
        let settlementCollectionRef;

        // --- Global App State ---
        let data = [];
        const today = new Date(); // Define today's date globally

        // D3 Selections
        let container, tooltip;

        // --- Global Setup: Updated Run Types ---
        const runTypes = ["(II) Run", "SSF Run", "(R1) Run", "(R2) Run", "(R3) Run", "(RF) Run", "(DF) Run"];
        const allPeriodTypes = ["Effective", "(II) Run", "SSF Run", "(R1) Run", "(R2) Run", "(R3) Run", "(RF) Run", "(DF) Run"];

        // D3 Formatters
        const parseDate = d3.timeParse("%d/%m/%Y");
        const formatFullDate = d3.timeFormat("%a, %d %B %Y");
        const formatShortDate = d3.timeFormat("%d/%m/%Y"); // UK Date Format
        const formatHtmlDate = d3.timeFormat("%Y-%m-%d");
        const formatWeeklyAxis = d3.timeFormat("%d/%m/%y");
        const formatMonthlyAxis = d3.timeFormat("%b %Y");
        const formatYearlyAxis = d3.timeFormat("%Y");

        // --- Color Palette ---
        const colors = {
            eonRed: "#FF4822",
            birch: "#FAF6F4",
            darkPurple: "#36164A",
            purple: "#5E0D98",
            flash: "#FF83FF",
            leaf: "#1AE570",
            sun: "#FFDE00",
            cloud: "#00E3FF",
            gasOff: "#9254FF",
        };

        // --- Data Color Scale ---
        const dataColorScale = d3.scaleOrdinal()
            .domain(allPeriodTypes)
            .range([
                colors.flash,  // Effective
                colors.leaf,   // (II) Run
                colors.sun,    // SSF Run
                colors.cloud,  // (R1) Run
                colors.gasOff, // (R2) Run
                colors.eonRed, // (R3) Run - Using eonRed
                colors.flash,  // (RF) Run - Reusing flash
                colors.darkPurple // (DF) Run - Used for marker
             ]);


        /**
         * Helper to parse YYYY-MM-DD string to a JS Date object safely.
         */
        function parseHtmlDate(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('-');
            if (parts.length === 3) {
                return new Date(parts[0], parts[1] - 1, parts[2]);
            }
            return null;
        }

        /**
         * Adds a number of days to a given date.
         */
        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        /**
         * Adds a number of months to a given date.
         */
        function addMonths(date, months) {
            const result = new Date(date);
            result.setMonth(result.getMonth() + months);
            return result;
        }

        /**
         * Calculates and displays stats based on current data.
         */
        function updateStats(data) {
            const totalSupplies = data.reduce((acc, d) => acc + (d["No of supplies"] || 0), 0);
            document.getElementById('stat-total').textContent = totalSupplies.toLocaleString('en-GB');

            const counts = { "Pre-Effective": 0 };
            allPeriodTypes.forEach(p => counts[p] = 0);

            for (const batch of data) {
                const supplies = batch["No of supplies"];
                let currentPeriod = "Pre-Effective"; // Default

                if (batch["Effective from date"] && today >= batch["Effective from date"]) currentPeriod = "Effective";
                if (batch["(II) Run"] && today >= batch["(II) Run"]) currentPeriod = "(II) Run";
                if (batch["SSF Run"] && today >= batch["SSF Run"]) currentPeriod = "SSF Run";
                if (batch["(R1) Run"] && today >= batch["(R1) Run"]) currentPeriod = "(R1) Run";
                if (batch["(R2) Run"] && today >= batch["(R2) Run"]) currentPeriod = "(R2) Run";
                if (batch["(R3) Run"] && today >= batch["(R3) Run"]) currentPeriod = "(R3) Run";
                if (batch["(RF) Run"] && today >= batch["(RF) Run"]) currentPeriod = "(RF) Run";
                if (batch["(DF) Run"] && today >= batch["(DF) Run"]) currentPeriod = "(DF) Run";

                counts[currentPeriod] += supplies;
            }

            // Update HTML for each stat box including Pre-Effective
            Object.keys(counts).forEach(period => {
                const el = document.getElementById(`stat-${period}`);
                if (el) {
                    el.textContent = counts[period].toLocaleString('en-GB');
                }
            });
        }

        // --- NEW: Function to show feedback messages ---
        let feedbackTimeout; // Store timeout ID globally
        function showFeedbackMessage(message, type = "success") {
            const feedbackEl = document.getElementById('feedback-message');
            if (!feedbackEl) return;

            feedbackEl.textContent = message;
            feedbackEl.className = `p-2 rounded text-sm mb-4 ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            feedbackEl.style.display = 'block';

            // Clear previous timeout if it exists
            if (feedbackTimeout) {
                clearTimeout(feedbackTimeout);
            }

            // Set a new timeout to hide the message
            feedbackTimeout = setTimeout(() => {
                feedbackEl.style.display = 'none';
            }, 3000); // Hide after 3 seconds
        }


        /**
         * Sets up the real-time listener to Firestore.
         */
        function setupFirestoreListener() {
            if (!isAuthReady || !appId) {
                console.error("Auth or AppId is not ready. Cannot set up listener.");
                return;
            }

            const collectionPath = `/artifacts/${appId}/shared_settlement_batches`;
            settlementCollectionRef = collection(db, collectionPath);

            onSnapshot(settlementCollectionRef, (snapshot) => {

                data = snapshot.docs.map(doc => {
                    const docData = doc.data();
                    const processedData = {
                        id: doc.id,
                        "No of supplies": docData["No of supplies"],
                        "Effective from date": docData["Effective from date"]?.toDate()
                    };
                    runTypes.forEach(run => {
                        if (docData[run]) {
                            processedData[run] = docData[run].toDate();
                        }
                    });
                    return processedData;
                });

                data = data.filter(d => d["Effective from date"]);

                updateStats(data);
                processAndDraw();
                renderManageDataUI();

            }, (error) => {
                console.error("Error with Firestore snapshot: ", error);
                showFeedbackMessage("Error loading data from database.", "error"); // Feedback on error
            });
        }


        /**
         * Processes the global 'data' array into segments and redraws the chart.
         */
        function processAndDraw() {
            const processedData = data.map(d => {
                const parsed = { ...d };
                const dates = [];
                if (parsed["Effective from date"]) {
                    dates.push({ type: "Effective", date: parsed["Effective from date"] });
                }

                runTypes.forEach(run => {
                    const runDate = parsed[run];
                    if (runDate) {
                        dates.push({ type: run, date: runDate });
                    }
                });

                dates.sort((a, b) => a.date - b.date);

                parsed.segments = [];
                // Loop stops *before* the last date (DF Run)
                for (let i = 0; i < dates.length - 1; i++) {
                    if (dates[i].date && dates[i+1].date && dates[i].date < dates[i+1].date) {
                        parsed.segments.push({
                            runType: dates[i].type,
                            startDate: dates[i].date,
                            endDate: dates[i + 1].date,
                            parentData: parsed
                        });
                    }
                }

                // Max date is the date of the last defined run (DF Run)
                parsed.maxDate = dates.length > 0 ? dates[dates.length - 1].date : parsed["Effective from date"];

                return parsed;
            });

            if (!container) return;
            const { width, height } = container.node().getBoundingClientRect();
            if (width > 0 && height > 0) {
                drawChart(width, height, processedData);
            }
        }

        /**
         * Renders the list of batches in the "Manage Data" tab.
         */
        function renderManageDataUI() {
            const listContainer = document.getElementById('batch-list-container');
            if (!listContainer) return;

            listContainer.innerHTML = '';

            if (data.length === 0) {
                listContainer.innerHTML = `<p class="text-sm" style="color: ${colors.darkPurple};">No settlement batches found. Add one using the form above.</p>`;
                return;
            }

            const sortedData = [...data].sort((a, b) => b["Effective from date"] - a["Effective from date"]);

            sortedData.forEach(batch => {
                const batchEl = document.createElement('div');
                batchEl.className = 'p-3 rounded-md shadow-sm border border-slate-200 flex justify-between items-center';
                batchEl.style.backgroundColor = colors.birch; // Birch background

                const infoEl = document.createElement('div');
                infoEl.className = 'text-sm';
                infoEl.innerHTML = `
                    <strong style="color: ${colors.darkPurple};">Effective: ${formatShortDate(batch["Effective from date"])}</strong>
                    <span class="ml-2" style="color: ${colors.darkPurple}; opacity: 0.7;">(Supplies: ${batch["No of supplies"]})</span>
                `;

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-xs px-3 py-1 rounded-md font-medium';
                deleteBtn.style.color = colors.eonRed;
                deleteBtn.style.backgroundColor = 'rgba(255, 72, 34, 0.1)';
                deleteBtn.textContent = 'Delete';
                deleteBtn.dataset.id = batch.id;

                deleteBtn.onmouseover = () => { deleteBtn.style.backgroundColor = 'rgba(255, 72, 34, 0.2)'; };
                deleteBtn.onmouseout = () => { deleteBtn.style.backgroundColor = 'rgba(255, 72, 34, 0.1)'; };


                deleteBtn.addEventListener('click', async () => {
                    if (confirm(`Are you sure you want to delete the batch for ${formatShortDate(batch["Effective from date"])}?`)) {
                        const id = deleteBtn.dataset.id;
                        if (id) {
                            try {
                                await deleteDoc(doc(db, settlementCollectionRef.path, id));
                                showFeedbackMessage("Batch deleted successfully!", "success"); // Feedback on delete
                            } catch (error) {
                                console.error("Error deleting document: ", error);
                                showFeedbackMessage("Error deleting batch.", "error"); // Feedback on error
                            }
                        }
                    }
                });

                batchEl.appendChild(infoEl);
                batchEl.appendChild(deleteBtn);
                listContainer.appendChild(batchEl);
            });
        }

        /**
         * Handles the submission of the "Add Batch" form.
         */
        async function handleAddBatch(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            try {
                const effectiveDate = parseHtmlDate(formData.get("effectiveDate"));
                if (!effectiveDate) {
                    alert("Effective from date is required.");
                    return;
                }

                // --- NEW: Input Validation for supplies ---
                const supplies = +formData.get("supplies");
                if (supplies <= 0) {
                     alert("Number of supplies must be greater than zero.");
                     return;
                }

                // Auto-calculate Settlement Dates based on your rules
                const newBatch = {
                    "Effective from date": Timestamp.fromDate(effectiveDate),
                    "No of supplies": supplies, // Use validated number
                    "(II) Run": Timestamp.fromDate(addDays(effectiveDate, 7)),     // 1 week
                    "SSF Run":  Timestamp.fromDate(addMonths(effectiveDate, 1)),  // 1 month
                    "(R1) Run": Timestamp.fromDate(addMonths(effectiveDate, 2)),  // 2 months
                    "(R2) Run": Timestamp.fromDate(addMonths(effectiveDate, 5)),  // 5 months
                    "(R3) Run": Timestamp.fromDate(addMonths(effectiveDate, 7)),  // 7 months
                    "(RF) Run": Timestamp.fromDate(addMonths(effectiveDate, 14)), // 14 months
                    "(DF) Run": Timestamp.fromDate(addMonths(effectiveDate, 28))  // 28 months
                };

                // Add to Firestore
                await addDoc(settlementCollectionRef, newBatch);
                showFeedbackMessage("Batch added successfully!", "success"); // Feedback on add

                form.reset();
                 // --- NEW: Reset date input to today after adding ---
                document.getElementById('effectiveDate').value = formatHtmlDate(new Date());


            } catch (error) {
                console.error("Error adding batch: ", error);
                showFeedbackMessage("Error adding batch.", "error"); // Feedback on error
            }
        }


        /**
         * The D3 drawing function.
         */
        function drawChart(containerWidth, containerHeight, chartData) {
            // --- NEW: Remove loading indicator ---
            container.select("#chart-loading").remove();
            container.selectAll("svg").remove();
            container.selectAll("p").remove(); // Clear previous error/empty messages

            if (chartData.length === 0) {
                 container.append("p")
                    .attr("class", "p-4 text-sm")
                    .style("color", colors.darkPurple)
                    .text("No valid data to display. Add data in the 'Manage Data' tab.");
                 return;
            }

            const margin = { top: 40, right: 50, bottom: 60, left: 90 };
            const width = containerWidth - margin.left - margin.right;
            const height = containerHeight - margin.top - margin.bottom;

            const svg = container.append("svg")
                .attr("width", containerWidth)
                .attr("height", containerHeight)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

            // --- 3. Scales ---
            const minDate = d3.min(chartData, d => d["Effective from date"]);
            const maxDateOverall = d3.max(chartData, d => d.maxDate); // Date of the last DF Run

            if (!minDate || !maxDateOverall) {
                 container.append("p")
                    .attr("class", "p-4 text-sm")
                    .style("color", colors.darkPurple)
                    .text("Could not determine date range from data.");
                 return;
            }

            // Define domain based on actual data + 1 month buffer
            const minDateBuffered = d3.timeMonth.offset(minDate, -1);
            const maxDateBuffered = d3.timeMonth.offset(maxDateOverall, 1);
            const dateDomain = [minDateBuffered, maxDateBuffered];

            const xScale = d3.scaleTime()
                .domain(dateDomain)
                .range([0, width]);

            const yScale = d3.scaleBand()
                .domain(chartData.map(d => d["Effective from date"]).sort((a,b) => a - b)) // Sort dates
                .range([0, height])
                .padding(0.4);

            // --- 4. Axes ---
            // Initial setup defaults to YEARLY ticks
            const xAxis = d3.axisBottom(xScale)
                            .ticks(d3.timeYear.every(1))
                            .tickFormat(formatYearlyAxis);

            const yAxis = d3.axisLeft(yScale).tickFormat(formatShortDate); // Uses UK format

            const xAxisGroup = svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0, ${height})`)
                .call(xAxis); // Initial call uses yearly ticks

            xAxisGroup.selectAll("text")
                .attr("transform", "rotate(-30)")
                .attr("text-anchor", "end")
                .attr("dx", "-.5em")
                .attr("dy", ".8em");

            svg.append("g")
                .attr("class", "y-axis")
                .call(yAxis)
                .selectAll("text")
                .attr("font-weight", "600");

            // --- 5. Chart Content ---
            svg.append("defs").append("clipPath")
                .attr("id", "clip")
                .append("rect")
                .attr("width", width)
                .attr("height", height);

            const chartArea = svg.append("g")
                .attr("clip-path", "url(#clip)");

            // --- Zoom Handler with Dynamic Axis Ticks ---
            const zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .translateExtent([
                    [xScale(minDateBuffered), -Infinity],
                    [xScale(maxDateBuffered), Infinity]
                 ])
                .extent([[0, 0], [width, height]])
                .on("zoom", (event) => {
                    const newXScale = event.transform.rescaleX(xScale);

                    // Dynamic Axis Ticks Logic based on visible time span
                    const currentDomain = newXScale.domain();
                    const timeSpanDays = d3.timeDay.count(currentDomain[0], currentDomain[1]);

                    let tickInterval = d3.timeYear.every(1); // Default to yearly
                    let tickFormat = formatYearlyAxis;

                    if (timeSpanDays <= 180) { // Less than ~6 months visible
                        tickInterval = d3.timeWeek.every(1); // Show weekly ticks
                        tickFormat = formatWeeklyAxis;
                    } else if (timeSpanDays <= 730) { // Between 6 months and 2 years visible
                         tickInterval = d3.timeMonth.every(1); // Show monthly ticks
                         tickFormat = formatMonthlyAxis;
                    } // else: More than 2 years, keep yearly (already set)


                    xAxisGroup.call(xAxis.scale(newXScale).ticks(tickInterval).tickFormat(tickFormat));

                    // Reapply rotation after calling axis
                    xAxisGroup.selectAll("text")
                        .attr("transform", "rotate(-30)")
                        .attr("text-anchor", "end")
                        .attr("dx", "-.5em")
                        .attr("dy", ".8em");

                    // Update chart elements (bars and end markers)
                    chartArea.selectAll(".run-bar")
                        .attr("x", d => newXScale(d.startDate))
                        .attr("width", d => Math.max(0, newXScale(d.endDate) - newXScale(d.startDate)));

                    chartArea.selectAll(".end-marker")
                         .attr("x", d => newXScale(d["(DF) Run"]) - 3); // Recalculate x based on new scale, keep centered

                    updateTodayMarker(newXScale);
                });

            chartArea.append("rect")
                .attr("class", "zoom-area")
                .attr("width", width)
                .attr("height", height)
                .style("fill", "none")
                .style("pointer-events", "all")
                .call(zoom);

            const batchGroups = chartArea.selectAll(".batch")
                .data(chartData, d => d.id)
                .enter()
                .append("g")
                .attr("class", "batch")
                .attr("transform", d => `translate(0, ${yScale(d["Effective from date"])})`);

            // Draw the bars for all segments EXCEPT the last one (DF Run)
            batchGroups.selectAll(".run-bar")
                .data(d => d.segments) // Segments array now excludes DF run start
                .enter()
                .append("rect")
                .attr("class", "run-bar")
                .attr("x", d => xScale(d.startDate))
                .attr("y", 0)
                .attr("width", d => Math.max(0, xScale(d.endDate) - xScale(d.startDate)))
                .attr("height", yScale.bandwidth())
                .attr("fill", d => dataColorScale(d.runType)) // Use new data color scale
                .attr("opacity", d => (today >= d.startDate && today < d.endDate) ? 1.0 : 0.6)
                .on("mouseover", (event, d) => {
                    tooltip.style("display", "block")
                        .html(`
                            <strong style="color: ${dataColorScale(d.runType)}">${d.runType} Period</strong><br>
                            Start: ${formatFullDate(d.startDate)}<br>
                            End: ${formatFullDate(d.endDate)}<br>
                            Duration: ${d3.timeDay.count(d.startDate, d.endDate)} days<br>
                            <hr>
                            <strong>Batch Info (Effective: ${formatShortDate(d.parentData["Effective from date"])})</strong><br>
                            Total Supplies: ${d.parentData["No of supplies"]}<br>

                            <span style="opacity: 0.8; font-size: 0.9em;">
                                (II) Run: ${d.parentData["(II) Run"] ? formatShortDate(d.parentData["(II) Run"]) : 'N/A'}<br>
                                SSF Run: ${d.parentData["SSF Run"] ? formatShortDate(d.parentData["SSF Run"]) : 'N/A'}<br>
                                (R1) Run: ${d.parentData["(R1) Run"] ? formatShortDate(d.parentData["(R1) Run"]) : 'N/A'}<br>
                                (R2) Run: ${d.parentData["(R2) Run"] ? formatShortDate(d.parentData["(R2) Run"]) : 'N/A'}<br>
                                (R3) Run: ${d.parentData["(R3) Run"] ? formatShortDate(d.parentData["(R3) Run"]) : 'N/A'}<br>
                                (RF) Run: ${d.parentData["(RF) Run"] ? formatShortDate(d.parentData["(RF) Run"]) : 'N/A'}<br>
                                (DF) Run: ${d.parentData["(DF) Run"] ? formatShortDate(d.parentData["(DF) Run"]) : 'N/A'}
                            </span>
                        `);
                })
                .on("mousemove", (event) => {
                    let left = event.clientX + 15;
                    let top = event.clientY - 15;

                    const tooltipNode = tooltip.node();
                    if (tooltipNode) {
                        const tooltipWidth = tooltipNode.offsetWidth;
                        const tooltipHeight = tooltipNode.offsetHeight;
                        if (left + tooltipWidth > window.innerWidth) left = event.clientX - tooltipWidth - 15;
                        if (top < 0) top = event.clientY + 15;
                        if (top + tooltipHeight > window.innerHeight) top = event.clientY - tooltipHeight - 15;
                    }
                    tooltip.style("left", left + "px").style("top", top + "px");
                })
                .on("mouseout", () => {
                    tooltip.style("display", "none");
                });

             // Add the End Marker (DF Run date)
             batchGroups.append("rect")
                .attr("class", "end-marker")
                .attr("x", d => xScale(d["(DF) Run"]) - 3) // Center the 6px square on the date
                .attr("y", (yScale.bandwidth() - 6) / 2) // Center vertically
                .attr("width", 6)
                .attr("height", 6)
                .attr("fill", colors.darkPurple) // Use Dark Purple
                .style("pointer-events", "all") // Ensure it can receive hover events
                 .on("mouseover", (event, d) => {
                    tooltip.style("display", "block")
                        .html(`
                            <strong>Dispute Final (DF) Run</strong><br>
                            Date: ${formatFullDate(d["(DF) Run"])}<br>
                            <hr>
                            Batch Effective: ${formatShortDate(d["Effective from date"])}
                        `);
                })
                 .on("mousemove", (event) => { // Re-add mousemove for positioning
                    let left = event.clientX + 15;
                    let top = event.clientY - 15;
                    const tooltipNode = tooltip.node();
                    if (tooltipNode) {
                        const tooltipWidth = tooltipNode.offsetWidth;
                        const tooltipHeight = tooltipNode.offsetHeight;
                        if (left + tooltipWidth > window.innerWidth) left = event.clientX - tooltipWidth - 15;
                        if (top < 0) top = event.clientY + 15;
                        if (top + tooltipHeight > window.innerHeight) top = event.clientY - tooltipHeight - 15;
                    }
                    tooltip.style("left", left + "px").style("top", top + "px");
                })
                .on("mouseout", () => {
                    tooltip.style("display", "none");
                });


            // --- 5b. Today Marker ---
            const todayMarker = chartArea.append("g")
                .attr("class", "today-marker")
                .style("pointer-events", "none");

            todayMarker.append("line")
                .attr("class", "today-line")
                .attr("y1", 0)
                .attr("y2", height)
                .attr("stroke", colors.eonRed) // Use E.ON Red
                .attr("stroke-width", 2)
                .attr("stroke-dasharray", "4 2");

            todayMarker.append("text")
                .attr("class", "today-text")
                .attr("x", 4)
                .attr("y", 15)
                .attr("fill", colors.eonRed) // Use E.ON Red
                .attr("font-size", "0.75rem")
                .attr("font-weight", "600")
                .text("Today");

            function updateTodayMarker(currentXScale) {
                const todayX = currentXScale(today);
                // Only display if within the visible chart area width
                const inRange = todayX >= 0 && todayX <= width;
                todayMarker.style("display", inRange ? "block" : "none");
                if (inRange) {
                    todayMarker.attr("transform", `translate(${todayX}, 0)`);
                }
            }
            updateTodayMarker(xScale);

            // --- 6. Legend ---
            // Filter out DF Run from legend as it's now just a marker
            const legendData = allPeriodTypes.filter(p => p !== "(DF) Run");
            const legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(0, -${margin.top / 2})`);

            const legendItems = legend.selectAll(".legend-item")
                .data(legendData) // Use filtered data
                .enter()
                .append("g")
                .attr("class", "legend-item")
                .attr("transform", (d, i) => `translate(${i * 80}, 0)`);

            legendItems.append("rect")
                .attr("x", 0)
                .attr("y", -5)
                .attr("width", 10)
                .attr("height", 10)
                .attr("fill", d => dataColorScale(d)); // Use data color scale

            legendItems.append("text")
                .attr("x", 15)
                .attr("y", 4)
                .text(d => d)
                .attr("font-size", "0.75rem")
                .style("fill", colors.darkPurple); // Use Dark Purple
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            container = d3.select("#chart-container");
            tooltip = d3.select("#tooltip");

            // --- Tab Switching Logic ---
            const tabChartBtn = document.getElementById('tab-chart');
            const tabDataBtn = document.getElementById('tab-data');
            const panelChartEl = document.getElementById('panel-chart');
            const panelDataEl = document.getElementById('panel-data');

            // Using Red for active tab
            const activeTabClasses = `border-b-2 font-medium text-sm mr-8 py-4 px-1 whitespace-nowrap`;
            const inactiveTabClasses = `border-transparent border-b-2 font-medium text-sm mr-8 py-4 px-1 whitespace-nowrap`;

            function setActiveTab(activeBtn, inactiveBtn) {
                 activeBtn.style.borderColor = colors.eonRed;
                 activeBtn.style.color = colors.eonRed;
                 inactiveBtn.style.borderColor = 'transparent';
                 inactiveBtn.style.color = colors.darkPurple; // Use dark purple for inactive text
                 inactiveBtn.classList.add('hover:border-slate-300', `hover:text-slate-700`); // Keep hover
                 activeBtn.classList.remove('hover:border-slate-300', `hover:text-slate-700`);
            }
            // Set initial active state
            setActiveTab(tabChartBtn, tabDataBtn);


            tabChartBtn.addEventListener('click', () => {
                setActiveTab(tabChartBtn, tabDataBtn);
                panelChartEl.className = 'flex h-[75vh]';
                panelDataEl.className = 'hidden h-[75vh] flex flex-col';

                if (container) {
                    const { width, height } = container.node().getBoundingClientRect();
                    if (width > 0 && height > 0 && data.length > 0) {
                        processAndDraw();
                    }
                }
            });

            tabDataBtn.addEventListener('click', () => {
                 setActiveTab(tabDataBtn, tabChartBtn);
                 panelDataEl.className = 'block h-[75vh] flex flex-col';
                 panelChartEl.className = 'hidden h-[75vh]';
            });

            // --- Add Batch Form Logic ---
            const addBatchForm = document.getElementById('add-batch-form');
            addBatchForm.addEventListener('submit', handleAddBatch);

            // --- NEW: Set default date for input ---
            document.getElementById('effectiveDate').value = formatHtmlDate(new Date());

            // --- Firebase Initialization ---
            try {
                if (!firebaseConfig.appId) {
                     throw new Error("Firebase 'appId' is missing or empty in your config.");
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setFirestoreLogLevel('debug');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Auth state ready, user ID:", userId);
                        setupFirestoreListener();
                    } else {
                        isAuthReady = false;
                        userId = null;
                        console.log("User is signed out.");
                    }
                });

                await signInAnonymously(auth);
                console.log("Signed in anonymously.");

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                if (container) {
                     container.append("p").attr("class", "text-red-500 p-4").text("Error: Could not connect to data storage. " + error.message);
                } else {
                     console.error("Could not display Firebase error in container element.");
                }
            }

            // --- Resize Observer ---
            const resizeObserver = new ResizeObserver(entries => {
                if (container && panelChartEl && !panelChartEl.classList.contains('hidden')) {
                    const entry = entries[0];
                    const { width, height } = entry.contentRect;
                    if (width > 0 && height > 0) {
                        processAndDraw();
                    }
                }
            });

            if (container) {
                resizeObserver.observe(container.node());
            } else {
                 console.error("Chart container not found for resize observer.");
            }
        });
    </script>
    <style>
        /* Apply Birch background to body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FAF6F4; /* Birch */
        }
        /* Style D3 elements with new colors */
        .x-axis path,
        .x-axis line,
        .y-axis path,
        .y-axis line {
            stroke: #e2e8f0; /* Keeping light gray for axis lines */
        }
        .x-axis text,
        .y-axis text {
            fill: #64748b; /* slate-500 for axis text */
            font-size: 0.75rem;
        }
        .run-bar:hover, .end-marker:hover { /* Apply hover to end marker too */
            opacity: 0.8;
            cursor: pointer;
        }
        #tooltip {
            background-color: #36164A; /* Dark Purple */
            color: white;
        }
        #tooltip hr {
            border-top: 1px solid #a8a29e; /* stone-400 - a lighter contrast */
            margin-top: 4px;
            margin-bottom: 4px;
        }
        #chart-container {
            min-height: 400px;
            background-color: white; /* Keep chart background white for clarity */
        }

        #add-batch-form .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        #add-batch-form label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: #36164A; /* Dark Purple */
            margin-bottom: 0.25rem;
        }
        #add-batch-form input {
            width: 100%;
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #cbd5e1; /* slate-300 */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); /* shadow-sm */
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
            color: #36164A; /* Dark Purple input text */
            background-color: white;
        }
         /* Style for smaller text on stats */
        #stats-bar h3 {
             font-size: 0.65rem; /* Smaller text for stat titles */
             color: #36164A; /* Dark Purple */
        }
        #stats-bar p {
             font-size: 1.25rem; /* Slightly smaller numbers */
             line-height: 1.5rem;
             color: #36164A; /* Dark Purple */
        }
         /* Specific style for Total stat title/value */
         #stats-bar > div:first-child h3 { color: #FF4822; } /* E.ON Red */
         #stats-bar > div:first-child p { color: #FF4822; } /* E.ON Red */

        /* Adjust grid for 10 items */
        @media (min-width: 1280px) { /* xl breakpoint */
             #stats-bar {
                 grid-template-columns: repeat(10, 1fr);
             }
        }

    </style>
</head>
<body class="h-full p-4 md:p-8">

    <div class="bg-white rounded-lg shadow-xl p-4 md:p-6 w-full max-w-7xl mx-auto flex flex-col min-h-[90vh]">
        <h1 class="text-2xl font-bold mb-4" style="color: #36164A;">Settlement Runs Timeline</h1>

        <div id="stats-bar" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-10 gap-3 mb-6 border-b pb-4 border-slate-200">
            <div class="p-3 rounded-lg shadow-sm border border-slate-200" style="background-color: #FAF6F4;">
                <h3 class="text-xs font-semibold truncate uppercase tracking-wider">Total Supplies</h3>
                <p id="stat-total" class="mt-1 text-xl md:text-2xl font-bold">-</p>
            </div>
            <div class="p-3 rounded-lg border border-slate-200" style="background-color: #FAF6F4;">
                <h3 class="text-xs font-semibold truncate uppercase tracking-wider">Pre-Effective</h3>
                <p id="stat-Pre-Effective" class="mt-1 text-xl md:text-2xl font-bold">-</p>
            </div>
            <div class="p-3 rounded-lg border border-slate-200" style="background-color: #FAF6F4;">
                <h3 class="text-xs font-semibold truncate uppercase tracking-wider">Effective</h3>
                <p id="stat-Effective" class="mt-1 text-xl md:text-2xl font-bold">-</p>
            </div>
            <div class="p-3 rounded-lg border border-slate-200" style="background-color: #FAF6F4;">
                <h3 class="text-xs font-semibold truncate uppercase tracking-wider">(II) Run</h3>
                <p id="stat-(II) Run" class="mt-1 text-xl md:text-2xl font-bold">-</p>
            </div>
            <div class="p-3 rounded-lg border border-slate-200" style="background-color: #FAF6F4;">
                <h3 class="text-xs font-semibold truncate uppercase tracking-wider">SSF Run</h3>
                <p id="stat-SSF Run" class="mt-1 text-xl md:text-2xl font-bold">-</p>
            </div>
            <div class="p-3 rounded-lg border border-slate-200" style="background-color: #FAF6F4;">
                <h3 class="text-xs font-semibold truncate uppercase tracking-wider">(R1) Run</h3>
                <p id="stat-(R1) Run" class="mt-1 text-xl md:text-2xl font-bold">-</p>
            </div>
            <div class="p-3 rounded-lg border border-slate-200" style="background-color: #FAF6F4;">
                <h3 class="text-xs font-semibold truncate uppercase tracking-wider">(R2) Run</h3>
                <p id="stat-(R2) Run" class="mt-1 text-xl md:text-2xl font-bold">-</p>
            </div>
            <div class="p-3 rounded-lg border border-slate-200" style="background-color: #FAF6F4;">
                <h3 class="text-xs font-semibold truncate uppercase tracking-wider">(R3) Run</h3>
                <p id="stat-(R3) Run" class="mt-1 text-xl md:text-2xl font-bold">-</p>
            </div>
            <div class="p-3 rounded-lg border border-slate-200" style="background-color: #FAF6F4;">
                <h3 class="text-xs font-semibold truncate uppercase tracking-wider">(RF) Run</h3>
                <p id="stat-(RF) Run" class="mt-1 text-xl md:text-2xl font-bold">-</p>
            </div>
            <div class="p-3 rounded-lg border border-slate-200" style="background-color: #FAF6F4;">
                <h3 class="text-xs font-semibold truncate uppercase tracking-wider">(DF) Run</h3>
                <p id="stat-(DF) Run" class="mt-1 text-xl md:text-2xl font-bold">-</p>
            </div>
        </div>
        <div id="feedback-message" style="display: none;"></div>

        <div class="mt-4">
            <div class="border-b border-slate-200">
                <nav class="flex -mb-px" aria-label="Tabs">
                     <button id="tab-chart" class="border-b-2 font-medium text-sm mr-8 py-4 px-1 whitespace-nowrap">
                        Timeline Chart
                    </button>
                    <button id="tab-data" class="border-transparent border-b-2 font-medium text-sm mr-8 py-4 px-1 whitespace-nowrap">
                        Manage Data
                    </button>
                </nav>
            </div>

            <div class="mt-6">
                <div id="panel-chart" class="flex h-[75vh]">
                    <div id="chart-container" class="flex-grow w-full h-full relative border rounded-md border-slate-200">
                         <p id="chart-loading" class="p-4 text-sm" style="color: #36164A;">Loading chart...</p>
                    </div>
                </div>

                <div id="panel-data" class="hidden h-[75vh] flex flex-col">

                    <h2 class="text-lg font-semibold mb-2" style="color: #36164A;">Add New Batch</h2>
                    <form id="add-batch-form" class="mb-6 p-4 border border-slate-200 rounded-lg" style="background-color: #FAF6F4;">
                        <div class="form-grid">
                            <div>
                                <label for="effectiveDate">Effective from date</label>
                                <input type="date" id="effectiveDate" name="effectiveDate" required>
                            </div>
                            <div>
                                <label for="supplies">No of supplies</label>
                                <input type="number" id="supplies" name="supplies" required min="1"> </div>
                        </div>
                        <button type="submit" class="mt-4 w-full md:w-auto text-white font-bold py-2 px-4 rounded-md transition-colors" style="background-color: #5E0D98;" onmouseover="this.style.backgroundColor='#36164A'" onmouseout="this.style.backgroundColor='#5E0D98'">
                            Add New Batch
                        </button>
                    </form>

                    <h2 class="text-lg font-semibold mb-2" style="color: #36164A;">Existing Batches</h2>
                    <div id="batch-list-container" class="flex-grow space-y-2 overflow-y-auto p-1">
                        <p class="text-sm" style="color: #36164A;">Loading data...</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="tooltip" class="fixed hidden text-xs rounded-md px-3 py-2 shadow-lg" style="pointer-events: none;"></div>

</body>
</html>
